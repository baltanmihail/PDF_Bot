# Запуск на Railway с нуля

Пошаговая инструкция: от репозитория до работающего сайта с аккаунтами и хранением PDF.

---

```bash
git add .
git commit -m "Деплой 3"
git push
```

## Чеклист после деплоя (обязательно)

Если контейнер уже запустился, но нужны аккаунты и сохранение файлов:

1. **Volume**  
   В сервисе: **Settings** → **Volumes** → **Add Volume**.  
   Mount Path: **`/data`**.

2. **Переменные (Variables)**  
   В сервисе: **Variables** → **Add Variable** (или **Raw Editor**). Добавьте:
   - `SECRET_KEY` = длинная случайная строка (например: `python -c "import secrets; print(secrets.token_urlsafe(32))"`).
   - `DATA_DIR` = `/data/outputs`
   - `DB_PATH` = `/data/auth.db`

3. **Перезапуск**  
   После добавления тома и переменных нажмите **Redeploy** (или новый деплой через **Deploy**).

---

## 1. Подготовка репозитория

- Код уже в Git (GitHub / GitLab).
- В корне есть: `web_app.py`, `core.py`, `auth_db.py`, `Dockerfile`, `requirements.txt`, `Procfile`.

---

## 2. Создание проекта в Railway

1. Зайдите на [railway.app](https://railway.app), войдите через GitHub.
2. **New Project** → **Deploy from GitHub repo**.
3. Выберите репозиторий с PDF_Bot.
4. Railway определит сборку (по `Dockerfile` или по `Procfile`). Если есть **Dockerfile** — лучше использовать его (в нём уже установлен LibreOffice для конвертации Word → PDF на Linux).

---

## 3. Volume для хранения PDF и БД

Без тома все файлы и SQLite пропадут при перезапуске.

1. В проекте откройте ваш **сервис**.
2. Вкладка **Variables** или **Settings** → **Volumes** (или **Add Volume**).
3. Создайте том, например имя `data`, путь монтирования: **`/data`**.
4. В **Variables** добавьте переменные:
   - `DATA_DIR=/data/outputs` — каталог для готовых PDF (внутри тома).
   - `DB_PATH=/data/auth.db` — путь к SQLite (на томе).
   - `SECRET_KEY=<случайная строка>` — для подписи сессий. Сгенерировать можно так:
     ```bash
     python -c "import secrets; print(secrets.token_urlsafe(32))"
     ```

Переменная `PORT` на Railway задаётся автоматически. В репозитории есть **railway.json** с командой запуска `python web_app.py` (приложение само читает `PORT` из окружения), чтобы не возникала ошибка `Invalid value for '--port': '$PORT'`.

---

## 3a. Если в логах ошибка «Invalid value for '--port': '$PORT'»

Railway мог подставить свою команду запуска (uvicorn с `$PORT`). Сделайте одно из двух:

1. **Через репозиторий:** В проекте должен быть файл **railway.json** с `"startCommand": "python web_app.py"`. Сделайте коммит и пуш — при следующем деплое команда подхватится.

2. **Вручную в Railway:** Сервис → **Settings** (или **Variables** рядом) → раздел **Deploy** / **Start Command** → в поле команды впишите:
   ```bash
   python web_app.py
   ```
   Сохраните и нажмите **Redeploy**.

---

## 4. Сборка и запуск

- Приложение запускается как `python web_app.py` и само читает порт из переменной **PORT** (Railway задаёт её автоматически).
- Если используется **Dockerfile**: Railway соберёт образ (Python + LibreOffice) и запустит приложение.
- Если без Dockerfile (только Procfile): в сервисе должен быть выбран **Stack** с поддеркой Python; на Railway при наличии `Procfile` часто используют Nixpacks. Тогда **LibreOffice не будет установлен** — конвертация Word не заработает. Имеет смысл оставить **Dockerfile** как основной способ деплоя.

После деплоя Railway покажет URL вида `https://your-app.up.railway.app`.

---

## 5. Проверка

1. Откройте URL в браузере.
2. Должна открыться страница входа (логин / регистрация).
3. Зарегистрируйтесь: логин = часть email до `@`, пароль — любой (≥ 4 символов).
4. После входа: форма загрузки ZIP или папки, прогресс, блок «Мои файлы».
5. Загрузите тестовый ZIP с .doc/.docx → дождитесь готовности → скачайте PDF. Файл сохранится на томе и появится в «Мои файлы».

---

## 6. Переменные окружения (сводка)

| Переменная    | Обязательно | Описание |
|---------------|-------------|----------|
| `SECRET_KEY`  | Да          | Секрет для подписи сессий (длинная случайная строка). |
| `DATA_DIR`    | Да (на Railway) | Каталог для PDF, например `/data/outputs`. Должен лежать на Volume. |
| `DB_PATH`     | Нет         | Путь к SQLite. По умолчанию `data/auth.db`. На Railway лучше `/data/auth.db`. |
| `PORT`        | Нет         | Задаёт Railway автоматически. |
| `MS_GRAPH_*`  | Нет         | Для конвертации через Word в облаке (см. раздел 6a). |

---

## 6a. Конвертация через Microsoft Word (точное форматирование для печати)

По умолчанию на Linux (Railway) используется **LibreOffice** — результат может отличаться от Word (шрифты, поля, разрывы страниц). Если нужна **точная вёрстка как в Word** (материалы в печать), можно включить конвертацию через **Microsoft Graph**: файлы конвертируются движком Word в облаке Microsoft.

**Требования:** подписка Microsoft 365 (или Azure AD с лицензией на OneDrive/SharePoint), учётная запись пользователя с OneDrive (например, отдельный «сервисный» аккаунт).

### Шаги настройки

1. **Регистрация приложения в Azure**
   - Зайдите в [portal.azure.com](https://portal.azure.com) → **Azure Active Directory** → **Регистрация приложений** → **Новая регистрация**.
   - Имя — любое (например, `PDF-Bot`). Тип учёта — «Учётные записи только в этом каталоге» или по необходимости.
   - После создания скопируйте **Идентификатор приложения (Application (client) ID)** и **Идентификатор каталога (Tenant ID)**.

2. **Секрет приложения**
   - В приложении: **Сертификаты и секреты** → **Новый секрет клиента** → скопируйте значение (оно показывается один раз).

3. **Права приложения (Application permissions)**
   - **Разрешения API** → **Добавить разрешение** → **Microsoft Graph** → **Разрешения приложения**.
   - Добавьте: **Files.ReadWrite.All** (чтение и запись файлов в OneDrive/SharePoint).
   - Нажмите **Предоставить согласие администратора** (нужны права администратора тенанта).

4. **Пользователь с OneDrive**
   - Нужен пользователь Azure AD / Microsoft 365, у которого есть OneDrive (обычный рабочий или учебный аккаунт). Приложение будет временно загружать в его OneDrive папку `AppTemp` файлы для конвертации и удалять их после получения PDF.
   - Узнайте **Object (ID) пользователя**: Azure AD → **Пользователи** → выберите пользователя → скопируйте **Идентификатор объекта**.

5. **Переменные в Railway**
   - В сервисе **Variables** добавьте:
     - `MS_GRAPH_CLIENT_ID` = идентификатор приложения (client ID).
     - `MS_GRAPH_CLIENT_SECRET` = значение секрета.
     - `MS_GRAPH_TENANT_ID` = идентификатор каталога (tenant ID).
     - `MS_GRAPH_USER_ID` = идентификатор объекта пользователя (см. п. 4).
   - Сделайте **Redeploy**.

Если все четыре переменные заданы, приложение будет конвертировать Word → PDF через Graph (Word в облаке). При ошибке или отсутствии переменных используется LibreOffice.

---

## 6b. Личный аккаунт Microsoft 365 (gmail.com, Family, OneDrive 1 ТБ)

Если у вас **личный** аккаунт (например click6636@gmail.com с подпиской Microsoft 365 Family), схема из раздела 6a **не подойдёт**: для личных аккаунтов Microsoft не даёт войти приложению «само по себе» (client credentials). Нужно **один раз войти под вашим аккаунтом** и сохранить refresh-токен. Дальше приложение будет использовать ваш OneDrive для конвертации (точное форматирование Word).

### Пошагово: Azure + Railway

1. **Зайдите в Azure**  
   Откройте [portal.azure.com](https://portal.azure.com) и войдите под вашим аккаунтом (click6636@gmail.com или тем, у кого есть M365 и OneDrive).

2. **Регистрация приложения**  
   - В поиске сверху введите **«Регистрация приложений»** (или **App registrations**) и откройте этот раздел.  
   - Нажмите **«+ Создать регистрацию»** (или **New registration**).  
   - **Имя** — любое, например `PDF-Bot`.  
   - **Поддерживаемые типы учётных записей** выберите один из:
     - **«Личные учётные записи Microsoft только»** (Personal Microsoft accounts only), или  
     - **«Учётные записи в любом каталоге и личные учётные записи Microsoft»** (если такой пункт есть).  
   - **URI перенаправления** пока оставьте пустым (добавим в следующем шаге).  
   - Нажмите **«Зарегистрировать»**.

3. **Скопируйте Client ID**  
   На открывшейся странице приложения скопируйте **Идентификатор приложения (клиента)** — это ваш **MS_GRAPH_CLIENT_ID** (длинная строка вида `12345678-1234-1234-1234-123456789abc`).

4. **Добавьте URI перенаправления**  
   - В меню слева выберите **«Проверка подлинности»** (Authentication).  
   - В блоке **«Платформы»** нажмите **«+ Добавить платформу»** → **«Веб»**.  
   - В поле **URI перенаправления** введите адрес вашего приложения на Railway + путь `/connect/callback`, например:  
     `https://ваш-проект.up.railway.app/connect/callback`  
     (подставьте свой URL из Railway; без слэша в конце).  
   - Внизу страницы нажмите **«Сохранить»**.

5. **Создайте секрет клиента**  
   - В меню слева: **«Сертификаты и секреты»** (Certificates & secrets).  
   - Нажмите **«+ Новый секрет клиента»**.  
   - Описание — например `PDF-Bot`, срок действия — по желанию (например 24 месяца).  
   - **«Добавить»** → сразу скопируйте **значение** секрета (оно показывается один раз). Это ваш **MS_GRAPH_CLIENT_SECRET**.

6. **Разрешения API**  
   - В меню слева: **«Разрешения API»** (API permissions).  
   - **«+ Добавить разрешение»** → выберите **Microsoft Graph** → **Делегированные разрешения** (Delegated permissions).  
   - Найдите и отметьте **Files.ReadWrite** (доступ к файлам OneDrive для чтения и записи).  
   - При необходимости добавьте **offline_access** (уже может быть в списке).  
   - Нажмите **«Добавить разрешения»**.  
   - Согласие администратора для личного аккаунта не нужно — вы дадите его при первом входе.

7. **Переменные в Railway**  
   В Railway → ваш сервис → **Variables** добавьте:
   - `MS_GRAPH_CLIENT_ID` = идентификатор приложения (из п. 3).  
   - `MS_GRAPH_CLIENT_SECRET` = значение секрета (из п. 5).  
   Сохраните и сделайте **Redeploy**, чтобы приложение подхватило переменные.

8. **Получение refresh-токена**  
   - Откройте в браузере: **https://ваш-проект.up.railway.app/connect** (тот же домен, что в п. 4).  
   - Вас перенаправит на вход Microsoft — войдите под вашим аккаунтом (click6636@gmail.com).  
   - Разрешите доступ к файлам (Files.ReadWrite).  
   - После входа откроется страница с большим полем **«Скопируйте refresh_token»**.  
   - Скопируйте **весь** текст из поля (это длинная строка).

9. **Добавьте refresh-токен в Railway**  
   - Railway → **Variables** → новая переменная:  
     **Имя:** `MS_GRAPH_REFRESH_TOKEN`  
     **Значение:** вставьте скопированный refresh-токен.  
   - Сохраните и снова **Redeploy**.

Готово. Конвертация Word → PDF будет идти через движок Word в облаке с использованием вашего OneDrive; форматирование будет совпадать с Word (удобно для материалов в печать). Переменные **MS_GRAPH_TENANT_ID** и **MS_GRAPH_USER_ID** для личного аккаунта **не нужны** — не добавляйте их.

### Ошибка: «Учётная запись не существует в клиенте» при входе на /connect

Если при переходе на `/connect` и входе под click6636@gmail.com появляется сообщение вроде **«Выделенная учётная запись пользователя не существует в клиенте "Microsoft Services"»** или **«не может обращаться к приложению … в этом клиенте»**, значит приложение в Azure разрешает вход только **учётным записям организации**, а не личным (gmail.com). Нужно разрешить личные учётные записи:

1. В Azure откройте **Регистрация приложений** → выберите ваше приложение (PDF-Bot).
2. В меню слева нажмите **«Манифест»** (Manifest).
3. В открывшемся JSON найдите строку **`"signInAudience"`**. Сейчас там, скорее всего, значение **`"AzureADMyOrg"`** (только каталог организации).
4. Замените его на **`"AzureADandPersonalMicrosoftAccount"`** (и личные учётные записи Microsoft). Должно получиться так:
   ```json
   "signInAudience": "AzureADandPersonalMicrosoftAccount",
   ```
5. Нажмите **«Сохранить»** вверху страницы.
6. Снова откройте в браузере **https://ваш-проект.up.railway.app/connect** и войдите под click6636@gmail.com — вход должен пройти.

Если при сохранении манифеста Azure выдаёт ошибку (например, про уникальность URI), можно вместо правки создать **новое** приложение (п. 2 раздела 6b) и при создании сразу выбрать тип учёта **«Личные учётные записи Microsoft только»** или **«Учётные записи в любом каталоге и личные учётные записи Microsoft»**, затем заново добавить Redirect URI, секрет и разрешения и подставить новый Client ID и секрет в Railway.

---

## 7. Где хранятся данные

- **Пользователи и задания:** SQLite-файл по пути `DB_PATH` (на томе — `/data/auth.db`).
- **Готовые PDF:** каталог `DATA_DIR`; внутри подпапки по `user_id`, в них — файлы PDF. Всё это на Volume, чтобы не терялось при рестартах.

Google Drive / OAuth подключать не обязательно: для «моих файлов» и скачивания достаточно тома на Railway. Если позже понадобится выгрузка в Google Drive, можно добавить отдельный модуль с Google API и переменными `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` и т.д.

---

## 8. Локальный запуск (без Docker)

Для проверки с аккаунтами и хранением локально:

```bash
pip install -r requirements.txt
set SECRET_KEY=local-secret
set DATA_DIR=./data/outputs
set DB_PATH=./data/auth.db
uvicorn web_app:app --host 127.0.0.1 --port 8000
```

Откройте http://127.0.0.1:8000. На Windows конвертация пойдёт через Word (COM), не через LibreOffice.
